(()=>{"use strict";var t={};t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}();class e extends Error{constructor(t,e,n){super(t),this.name="StyraRunError",this.query=e,this.cause=n}}class n extends Error{constructor(t,e,n){super(t),this.name="StyraRunHttpError",this.statusCode=e,this.body=n}}function r(t){return!0===t?.result}class s{url;callbacks;eventListeners;constructor(t,{callbacks:e={},eventListeners:n=[]}={}){this.url=t,this.callbacks=e,this.eventListeners=n,this.callbacks.disable||(this.callbacks.disable=c),this.callbacks.hide||(this.callbacks.hide=o)}async handleEvent(t,e){this.eventListeners.forEach((n=>n(t,e)))}async query(t,e){return(await this.batchedQuery([{path:t,input:e}]))[0]}async check(t,e,n=r){const s=await this.query(t,e);return await n(s)}async batchedQuery(t){if(!Array.isArray(t))throw new Error("'queries' is not a valid array");try{const e=await async function(t,e){const r=await fetch(t,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},dataType:"json",body:JSON.stringify(e)});if(200!==r.status)throw new n(`Unexpected status code: ${r.status}`,r.status,r.text());return await r.json()}(this.url,t);return this.handleEvent("query",{queries:t,result:e}),e}catch(n){throw this.handleEvent("query",{queries:t,err:n}),new e("Query failed",t,n)}}async refresh(t=document){let e=Array.from(t.querySelectorAll("[authz]"));const n=e.map((t=>{const e={path:t.getAttribute("authz")};let n,r=t.getAttribute("authz:input-func");if(r)n=i(r,this.callbacks)(t);else{let e=t.getAttribute("authz:input");if(e)try{n=JSON.parse(e)}catch{n=e}}return n&&(e.input=n),e}));if(n.length>0){const t=await this.batchedQuery(n);await Promise.allSettled(t.map((async(t,n)=>{const r=e[n];this.handleEvent("authz",{elem:r,decision:t}),function(t,e,n){let r=e.getAttribute("authz:action");if(r)i(r,n)(t,e);else{if(e.attributes.hasOwnProperty("hidden"))return e.setAttribute("authz:action","hide"),void o(t,e);e.setAttribute("authz:action","disable"),c(t,e)}}(t,r,this.callbacks)})))}}}function i(t,e){let n=e[t];if(n)return n;if(window.hasOwnProperty(t))return window[t];throw Error(`Unknown function '${t}'`)}function a(t){return!0===t?.result}function c(t,e){a(t)?e.removeAttribute("disabled"):e.setAttribute("disabled","true")}function o(t,e){a(t)?e.removeAttribute("hidden"):e.setAttribute("hidden","true")}function u(t,e={}){return new s(t,e)}const h=u("/authz"),l={New:u,check:function(t){return h.check(t)},refresh:function(t=document){return h.refresh(t)}};class d{constructor(t,e,n){this.url=t,this.anchor=e,this.styraRunClient=n}renderRoleSelector(t,e,n){const r=document.createElement("select");if(r.onchange=t=>{this.setBinding(n.id,t.target.value)},void 0===n.role||n||!e.includes(n.role)){const t=document.createElement("option");t.setAttribute("disabled",!0),t.setAttribute("selected",!0),t.innerText=n.role??"",r.appendChild(t)}e.forEach((t=>{const e=document.createElement("option");e.innerText=t,e.setAttribute("value",t),n.role===t&&e.setAttribute("selected",!0),r.appendChild(e)})),t.appendChild(r)}async setBinding(t,e){try{await fetch(`${this.url}/user_bindings/${t}`,{method:"PUT",headers:{"content-type":"application/json"},body:JSON.stringify([e])}).then((async t=>{if(200!==t.status)throw new Error(`Unexpected status code ${t.status}`)})),this.styraRunClient.handleEvent("rbac-update",{id:t,role:e})}catch(n){this.styraRunClient.handleEvent("rbac-update",{id:t,role:e,err:n})}await this.refresh()}async renderRbacManager(){const[t,e]=await Promise.all([fetch(this.url+"/roles").then((t=>200==t.status?t.json():[])),fetch(this.url+"/user_bindings").then((t=>200==t.status?t.json():{}))]);this.styraRunClient.handleEvent("rbac",{roles:t,bindings:e});const n=document.createElement("table");n.insertRow().innerHTML="\n      <th>User</th>\n      <th>Role</th>",e.forEach((e=>{const r=void 0!==e.roles?e.roles[0]:void 0,s={id:e.id,role:r},i=n.insertRow();i.insertCell().appendChild(document.createTextNode(s.id));const a=i.insertCell();this.renderRoleSelector(a,t,s)})),this.anchor.innerHTML="",this.anchor.appendChild(n)}async refresh(){try{await this.renderRbacManager()}catch(t){this.styraRunClient.handleEvent("rbac",{err:t})}}}t.g.StyraRun=l,t.g.StyraRun.setupRbacManagement=async function(t,e,n=h){const r=document.querySelector(e);if(r){const e=new d(t,r,n);await e.refresh()}}})();